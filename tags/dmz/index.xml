<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Dmz on </title>
    <link>http://wyb0.com/tags/dmz/</link>
    <description>Recent content in Dmz on </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>&amp;copy; 2016-2017 Reber. All Rights Reserved.</copyright>
    <lastBuildDate>Tue, 05 Jul 2016 09:56:35 +0800</lastBuildDate>
    <atom:link href="http://wyb0.com/tags/dmz/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>iptables简单配置DMZ</title>
      <link>http://wyb0.com/posts/iptables%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AEDMZ/</link>
      <pubDate>Tue, 05 Jul 2016 09:56:35 +0800</pubDate>
      
      <guid>http://wyb0.com/posts/iptables%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AEDMZ/</guid>
      <description>

&lt;h2 id=&#34;要求:048f0b8adabe78f01c35e47696f601c8&#34;&gt;要求&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;内网可以访问外网&lt;/li&gt;
&lt;li&gt;内网可以访问DMZ区&lt;/li&gt;
&lt;li&gt;外网不能访问内网&lt;/li&gt;
&lt;li&gt;外网能访问DMZ区的服务&lt;/li&gt;
&lt;li&gt;DMZ区不能访问内网&lt;/li&gt;
&lt;li&gt;DMZ区不能主动访问外网&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;拓扑:048f0b8adabe78f01c35e47696f601c8&#34;&gt;拓扑&lt;/h2&gt;

&lt;blockquote&gt;

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_topology.png&#34; alt=&#34;iptables简单配置DMZ的拓扑.png&#34;&gt;
&lt;/div&gt;

&lt;/blockquote&gt;

&lt;h2 id=&#34;个主机ip信息:048f0b8adabe78f01c35e47696f601c8&#34;&gt;个主机IP信息&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;内网网段为：192.168.1.0/24&lt;br /&gt;
DMZ区网段为：172.16.1.0/24

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_ip_info.png&#34; alt=&#34;iptables简单配置DMZ的ip信息.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;iptables的策略:048f0b8adabe78f01c35e47696f601c8&#34;&gt;iptables的策略&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;新建iptables.sh,内容如下：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash

iptables –F #清空此表中的规则
iptables –X #清空此表中的自定义规则
iptables –Z #清空此表中的计数器为0
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

iptables -F -t nat
iptables -X -t nat
iptables -Z -t nat
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT
iptables -t nat -P OUTPUT ACCEPT

#添加必要的模块
modprobe ip_nat_ftp
modprobe iptable_nat
modprobe ip_conntrack
modprobe ip_conntrack_ftp
#开启转发功能
echo &amp;quot;1&amp;quot; &amp;gt; /proc/sys/net/ipv4/ip_forward
#********************************************************************
#PREROUTING：
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 172.16.1.1
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 21 -j DNAT --to-destination 172.16.1.1
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 10000:10100 -j DNAT --to-destination 172.16.1.1
iptables -t nat -A PREROUTING -i eth2 -p tcp -d 172.16.1.1 --dport 80 -j DNAT --to-destination 172.16.1.1
iptables -t nat -A PREROUTING -i eth2 -p tcp --dport 80 -j DNAT --to-destination 192.168.2.144
#********************************************************************
#FORWARD：
iptables -A FORWARD -m state --state INVALID -j DROP
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m state --state NEW -j ACCEPT
iptables -A FORWARD -i eth2 -o eth0 -m state --state NEW -j ACCEPT
iptables -A FORWARD -i eth2 -o eth1 -m state --state NEW -j ACCEPT
#********************************************************************
#INPUT：
iptables -A INPUT -m state --state INVALID -j DROP
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -i eth0 -p tcp –m multiport --dports 20,21 -j ACCEPT
iptables -A INPUT -i eth2 -s 192.168.1.0/24 -j ACCEPT
#********************************************************************
#OUTPUT：
iptables -A OUTPUT -m state --state INVALID -j DROP
iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth1 -p tcp --dport 80 -m state --state NEW -j ACCEPT
iptables -A OUTPUT -o eth1 -p tcp --dport 20 -m state --state NEW -j ACCEPT
iptables -A OUTPUT -o eth1 -p tcp --dport 21 -m state --state NEW -j ACCEPT
iptables -A OUTPUT -o eth1 -p tcp --dport 10000:10100 -m state --state NEW -j ACCEPT
#********************************************************************
#POSTROUTING：
iptables -t nat -A POSTROUTING -o eth0 -s 192.168.1.0/24 -j SNAT --to-source 192.168.2.144
iptables -t nat -A POSTROUTING -o eth0 -s 172.16.1.0/24 -j SNAT --to-source 192.168.2.144
#********************************************************************
service iptables save
service iptables restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;测试:048f0b8adabe78f01c35e47696f601c8&#34;&gt;测试&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;内网可以访问外网

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_lan_to_internet.png&#34; alt=&#34;内网可以访问外网.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;内网可以访问DMZ

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_lan_to_dmz_www.png&#34; alt=&#34;内网可以访问DMZ的www.png&#34;&gt;
&lt;/div&gt;


&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_lan_to_dmz_ftp.png&#34; alt=&#34;内网可以访问DMZ的ftp.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;外网不能访问内网

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_internet_not_to_lan.png&#34; alt=&#34;外网不能访问内网.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;外网可以访问DMZ

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_internet_to_dmz_www.png&#34; alt=&#34;外网可以访问DMZ的www.png&#34;&gt;
&lt;/div&gt;


&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_internet_to_dmz_ftp.png&#34; alt=&#34;外网可以访问DMZ的ftp.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;DMZ不能访问内网

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_dmz_not_to_lan.png&#34; alt=&#34;DMZ不能访问内网.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;DMZ不能访问外网

&lt;div class=&#34;pure-u-1&#34;&gt;
  &lt;img class=&#34;pure-img&#34; src=&#34;http://wyb0.com/img/post/iptables_dmz_dmz_not_to_internet.png&#34; alt=&#34;DMZ不能访问外网.png&#34;&gt;
&lt;/div&gt;
&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
    </item>
    
  </channel>
</rss>