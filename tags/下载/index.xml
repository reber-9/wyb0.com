<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>下载 on </title>
    <link>http://wyb0.com/tags/%E4%B8%8B%E8%BD%BD/</link>
    <description>Recent content in 下载 on </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>&amp;copy; 2016-2017 Reber. All Rights Reserved.</copyright>
    <lastBuildDate>Tue, 24 May 2016 08:31:09 +0800</lastBuildDate>
    <atom:link href="http://wyb0.com/tags/%E4%B8%8B%E8%BD%BD/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>PHP之上传与下载</title>
      <link>http://wyb0.com/posts/PHP%E4%B9%8B%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/</link>
      <pubDate>Tue, 24 May 2016 08:31:09 +0800</pubDate>
      
      <guid>http://wyb0.com/posts/PHP%E4%B9%8B%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/</guid>
      <description>

&lt;h2 id=&#34;上传:cf817d8c79d597602d7618c4a1130c46&#34;&gt;上传&lt;/h2&gt;

&lt;h3 id=&#34;客户端设置:cf817d8c79d597602d7618c4a1130c46&#34;&gt;客户端设置&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;客户端使用form表单上传文件，在form表单中必须指明enctype和method属性的值&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
    &amp;lt;title&amp;gt;post&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
    &amp;lt;form action=&amp;quot;xx.php&amp;quot; mothod=&amp;quot;post&amp;quot; enctype=&amp;quot;multipart/form-data&amp;quot;&amp;gt;
        &amp;lt;input type=&amp;quot;file&amp;quot; value=&amp;quot;myfile&amp;quot; /&amp;gt;&amp;lt;br /&amp;gt;
        &amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;提交&amp;quot; /&amp;gt;
    &amp;lt;/form&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;服务端设置:cf817d8c79d597602d7618c4a1130c46&#34;&gt;服务端设置&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;php.ini:&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;file_uploads = On   //默认允许HTTP文件上传，此选项不能设置为OFF
upload_tmp_dir=    //文件上传时存放文件的临时目录
upload_max_filesize = 20M   //设定单个文件上传的大小，必须小于post_max_size
post_max_size = 19M   //允许POST表单的数据最大大小
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;$_FILES:&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;$_FILES[&#39;upload_file&#39;][&#39;name&#39;]  //带扩展名的原始文件名
$_FILES[&#39;upload_file&#39;][&#39;size&#39;]  //文件大小
$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]  //临时文件名
$_FILES[&#39;upload_file&#39;][&#39;error&#39;]  //上传文件时的错误信息
$_FILES[&#39;upload_file&#39;][&#39;type&#39;]  //上传文件的类型

//type是上传文件时原始信息里的content_type,即MIME,有image/gig、text/html等
//error一般有5中类型：
//0 上传成功
//1 文件大小超过了upload_max_filesize
//2 文件大小超过了表单总MAX_FILE_SIZE设定的值
//3 只有部分被上传
//4 没有上传任何文件
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;服务端上传步骤&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;1. 判断uploads这个文件夹存在
2. 判断error的值
3. 判断文件后缀是否合法
4. 判断MIME的类型和子类型是否合法
5. 判断文件大小
6. 对文件进行重命名
7. 移动
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;服务端接收脚本&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
    //执行文件（图片）上传
    echo &amp;quot;&amp;lt;pre&amp;gt;&amp;quot;;
    var_dump($_FILES);
    echo &amp;quot;&amp;lt;/pre&amp;gt;&amp;quot;;

    //1.获取上传文件信息
     $upfile = $_FILES[&amp;quot;pic&amp;quot;]; //html的form表单的input中name属性值要为pic
     $typelist = array(&amp;quot;image/jpeg&amp;quot;,&amp;quot;image/jpg&amp;quot;,&amp;quot;image/png&amp;quot;,&amp;quot;image/gif&amp;quot;); //定义允许的类型
     $path=&amp;quot;./uploads/&amp;quot;;  //定义一个上传过后的目录

    //2. 过滤上传文件的错误号
    if($upfile[&amp;quot;error&amp;quot;]&amp;gt;0){
        //获取错误信息
        switch($upfile[&#39;error&#39;]){
            case 1:
                $info=&amp;quot;上传的文件超过了 php.ini 中 upload_max_filesize 选项限制的值。&amp;quot;; 
                break;
            case 2:
                $info=&amp;quot;上传文件的大小超过了 HTML 表单中 MAX_FILE_SIZE 选项指定的值。&amp;quot;; 
                break;
            case 3:
                $info=&amp;quot;文件只有部分被上传。&amp;quot;; 
                break;
            case 4:
                $info=&amp;quot;没有文件被上传。 &amp;quot;;
            case 6:
                $info=&amp;quot;找不到临时文件夹。&amp;quot;; 
                break;
            case 7:
                $info=&amp;quot;文件写入失败&amp;quot;; 
                break;
        }

        die(&amp;quot;上传文件错误，原因：&amp;quot;.$info);
    }
  
    //3. 本次上传文件到小的过滤（自己选择）
    if($upfile[&amp;quot;size&amp;quot;]&amp;gt;100000){
        die(&amp;quot;上传文件大小超出限制！&amp;quot;);
    }
    
    //4. 类型过滤
    if(!in_array($upfile[&amp;quot;type&amp;quot;],$typelist)){
        die(&amp;quot;上传文件类型非法！&amp;quot;.$upfile[&amp;quot;type&amp;quot;]);
    }

    //5. 上传后的文件名定义(随机获取一个文件名（保持后缀名不变）)
    $fileinfo = pathinfo($upfile[&amp;quot;name&amp;quot;]);//解析上传文件名字
    do{
        $newfile= date(&amp;quot;YmdHis&amp;quot;).rand(1000,9999).&amp;quot;.&amp;quot;.$fileinfo[&amp;quot;extension&amp;quot;];
    }while(file_exists($path.$newfile));
    //6. 执行文件上传
    //判断是否是一个上传的文件
    if(is_uploaded_file($upfile[&amp;quot;tmp_name&amp;quot;])){
        //执行文件上传（移动上传文件）
        if(move_uploaded_file($upfile[&amp;quot;tmp_name&amp;quot;],$path.$newfile)){
            echo &amp;quot;文件上传成功！&amp;quot;;
            echo &amp;quot;&amp;lt;h3&amp;gt;&amp;lt;a href=&#39;index.php&#39;&amp;gt;浏览&amp;lt;/a&amp;gt;&amp;lt;/h3&amp;gt;&amp;quot;;
        }else{
            die(&amp;quot;上传文件失败&amp;quot;);
        }
    }else{
        die(&amp;quot;不是一个上传文件！&amp;quot;);
    }
?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;下载:cf817d8c79d597602d7618c4a1130c46&#34;&gt;下载&lt;/h2&gt;

&lt;blockquote&gt;
&lt;h3 id=&#34;对于php无法解析的类型:cf817d8c79d597602d7618c4a1130c46&#34;&gt;对于php无法解析的类型&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;a href=&amp;quot;http://www.aa.com/xx.rar&amp;quot;&amp;gt;下载&amp;lt;/a &amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;对于php能解析的文件-同时为了安全性:cf817d8c79d597602d7618c4a1130c46&#34;&gt;对于php能解析的文件(同时为了安全性)&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
    header(&amp;quot;Content-type:text/html;charset=utf-8&amp;quot;);
    $file_name = &amp;quot;文件.exe&amp;quot;;
    $file_name=iconv(&amp;quot;utf-8&amp;quot;,&amp;quot;gb2312&amp;quot;,$file_name); //解决中文不能显示的问题 
    $file_dir = &amp;quot;/public/www/download/&amp;quot;;
    $file_path = $file_dir.$file_name;
    if (!file_exists($file_path)) { //检查文件是否存在
        echo &amp;quot;文件找不到&amp;quot;;
        exit;
    } else {
        $file = fopen($file_path,&amp;quot;r&amp;quot;); // 打开文件
        Header(&amp;quot;Accept-Ranges: bytes&amp;quot;);//代表支持断点续传
        // 输入文件标签,下面3个Header是必须的
        Header(&amp;quot;Content-type: application/octet-stream&amp;quot;);
        Header(&amp;quot;Accept-Length: &amp;quot;.filesize($file_path));
        Header(&amp;quot;Content-Disposition: attachment; filename=&amp;quot; . $file_name);
        // 输出文件内容
        echo fread($file,filesize($file_path));
        fclose($file);
        exit;
    }
?&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;
</description>
    </item>
    
  </channel>
</rss>